package com.example.gigacf.comm.filter;

import java.io.IOException;

import javax.servlet.*;
import javax.servlet.annotation.WebFilter;
import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.springframework.http.converter.protobuf.ProtobufHttpMessageConverter;

import lombok.extern.log4j.Log4j2;

/** ë°°ê²½ì§€ì‹ : í•„í„°
 * 1. ì˜ì˜ : ê³µí†µëœ ì‘ì—… ìˆ˜í–‰ì„ ìœ„í•´ì„œ ì‚¬ìš©ë˜ë©°, ë¡œê·¸ì¸ ì—¬ë¶€ë¥¼ í™•ì¸ í˜¹ì€ character encoding ë“±ìœ¼ë¡œ ì£¼ë¡œ ì‚¬ìš©ë¨
 * 2. ì‘ë™ìœ„ì¹˜ : WAS -> "Filter" -> Servlet -> Interceptor -> Controller
 * 3. ì¸í„°ì…‰í„°ì™€ ë¹„êµ : í•„í„°ëŠ” ì„œë¸”ë¦¿ìª½ ê¸°ìˆ ì´ë©°, ì¸í„°ì…‰í„°ëŠ” ìŠ¤í”„ë§ìª½ ê¸°ìˆ ì„. ë”°ë¼ì„œ ì¸í„°ì„¼í„°ëŠ” ìŠ¤í”„ë§ì˜ ê¸°ìˆ ì´ ì ìš©ë  ìˆ˜ ìˆìŒ.
 * */

/**
 * ì´ í´ë˜ìŠ¤ì˜ ì—­í•  : ë¡œê·¸ì¸ í™•ì¸ í•„í„° Menuì™€ Memberì˜ ë©”ë‰´ì— ì§„ì…í•˜ë ¤ê³  í•˜ë©´, login í™”ë©´ìœ¼ë¡œ ì´ë™í•˜ëŠ” ê¸°ëŠ¥
 */
@WebFilter(urlPatterns = { "/v2/menu/*", "/v2/member/*" }) // í•´ë‹¹ ê²½ë¡œì— ëŒ€í•˜ì—¬ filtering
@Log4j2
public class LoginCheckFilter implements Filter {

	@Override
	public void init(FilterConfig filterConfig) throws ServletException {
		log.info("FirstFilterê°€ ìƒì„± ë©ë‹ˆë‹¤.");
	}

	@Override
	public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, // doFilterì˜ íŒŒë¼ë¯¸í„°ì—ëŠ”
																							// Servlet(HttpServlet â¨‰)ì„
																							// ì‚¬ìš©í•˜ì—¬ì•¼í•¨
			FilterChain filterChain // FilterChain : ì„œë¸”ë¦¿ì„ ì‹¤í–‰ì‹œì¼œì¤Œ
	) throws IOException, ServletException {

		log.info("ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡Login Check filter excutedğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡");

		/**
		 * HttpServlet ê°ì²´ ë¶ˆëŸ¬ì˜¤ê¸° íŒŒë¼ë¯¸í„°ì˜ ì„œë¸”ë¦¿ì„ ê°€ì ¸ì™€ ë‹¤ìš´ ìºìŠ¤íŠ¸ í•˜ì—¬ HttpServlet ê°ì²´ ë¶ˆëŸ¬ì˜¤ê¸°
		 */
		HttpServletRequest httpServletRequest = (HttpServletRequest) servletRequest;
		HttpServletResponse httpServletResponse = (HttpServletResponse) servletResponse;

		/**
		 * ì„¸ì…˜ì •ë³´ ì¡°íšŒí•˜ì—¬ í›„ì²˜ë¦¬ 1. httpServletRequest ê°ì²´ì—ì„œ ì„¸ì…˜ ë¶ˆëŸ¬ì™€ì„œ ì„¸ì…˜ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì„¸ì…˜ì´ ì—†ë‹¤ë©´ login
		 * í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ê¸° 2. ë¡œê·¸ì¸í•˜ì—¬ ìƒì„±í•˜ì˜€ë˜ ì¿ í‚¤ê°€ ìˆë‹¤ë©´ ì²´í¬í•´ì„œ ì‚­ì œí•´ì£¼ê¸°
		 */
		try {
			HttpSession httpSession = httpServletRequest.getSession(false); // ì„¸ì…˜ ê°ì²´ë¥¼ ë¶ˆëŸ¬ì˜´(ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì„¸ì…˜ì´ ì—†ë‹¤ë©´ ì„¸ì…˜ì„ ìƒì„±í•˜ì§€ ì•ŠìŒ.)
			if (httpSession.getAttribute("loginSessionVo") == null) {
				Cookie[] requestCookies = httpServletRequest.getCookies(); // ì„¸ì…˜ì´ ì—†ìœ¼ë©´ Html ë¡œê·¸ì¸ë²„íŠ¼ ì„¤ì •ì„ ìœ„í•´ ë¸Œë¼ìš°ì €ì— ì €ì¥ëœ ì¿ í‚¤
																			// ì‚­ì œí•˜ê¸°
				if (requestCookies != null) {
					for (Cookie cookie : requestCookies) {
						if ("identifyLoginCookie".equals(cookie.getName())) {
							log.info("identifyLoginCookie will be deleted... : " + cookie.getName());
							cookie.setMaxAge(0);
							cookie.setPath("/v2");
							httpServletResponse.addCookie(cookie);
							break;
						}
					}
				}
				httpServletResponse.sendRedirect("/v2/user/login/loginForm");

				return;
			}
		} catch (RuntimeException e) {
			httpServletResponse.sendRedirect("/v2/user/login/loginForm");

			return;
		}

		/* ë‹¤ìŒ í•„í„°ë‚˜ ëª©ì ì§€(ì„œë¸”ë¦¿, JSP)ë¡œ ê°ˆ ìˆ˜ ìˆë„ë¡ doFilter ì„¤ì •í•˜ê¸° */
		filterChain.doFilter(servletRequest, servletResponse);
	}

	@Override
	public void destroy() {
		log.info("FirstFilterê°€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.");
	}

}
